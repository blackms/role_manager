{% extends "base.html" %}

{% block title %}Home - Role Manager{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{% endblock %}

{% block content %}
<h1 class="mb-4">Role Manager</h1>
<form id="request-role-form" class="mb-4">
    <div class="form-group">
        <label for="player">Player Name:</label>
        <input type="text" class="form-control" id="player" name="player" required>
        <div id="player-error" class="error-message" style="display: none;">Player name must be in the format [alliance]playername.</div>
    </div>
    <div class="form-group">
        <label for="role">Requested Role:</label>
        <select class="form-control" id="role" name="role" required>
            <option value="secretary_of_strategy">Secretary of Strategy</option>
            <option value="secretary_of_security">Secretary of Security</option>
            <option value="secretary_of_development">Secretary of Development</option>
            <option value="secretary_of_science">Secretary of Science</option>
            <option value="secretary_of_interior">Secretary of Interior</option>
        </select>
    </div>
    <div class="form-group">
        <label for="coordinates">Coordinates (optional):</label>
        <input type="text" class="form-control" id="coordinates" name="coordinates">
    </div>
    <button type="submit" class="btn btn-primary">Request Role</button>
</form>

<h2 class="mb-3">Current Roles</h2>
<ul class="list-group mb-4" id="current-roles">
    <!-- Will be populated by jQuery -->
</ul>

<h2 class="mb-3">Waiting Queue</h2>
<ul class="list-group" id="waiting-queue">
    <!-- Will be populated by jQuery -->
</ul>

<script>
    let timers = {}; // Store timers for each role

    function fetchRoles() {
        $.ajax({
            url: '/api/roles',
            method: 'GET',
            success: function(data) {
                console.log(data);  // Log the data to the console for debugging

                var currentRoles = $('#current-roles');
                var waitingQueue = $('#waiting-queue');
                currentRoles.empty();
                waitingQueue.empty();

                // Clear existing timers
                for (let role in timers) {
                    clearInterval(timers[role]);
                }
                timers = {};

                // Populate current roles
                data.assignments.forEach(function(assignment) {
                    var listItem = $('<li class="list-group-item d-flex justify-content-between align-items-center"></li>');
                    var roleText = `${assignment.role.replace('_', ' ')}: ${assignment.player}`;
                    var badge = assignment.remaining_time ? `<span id="time_${assignment.role}" class="badge badge-primary badge-pill">${Math.floor(assignment.remaining_time)}:00</span>` : '';
                    var releaseButton = `<a href="#" onclick="releaseRole('${assignment.role}')" class="btn btn-danger btn-sm ml-2">Release</a>`;
                    listItem.html(`${roleText}<div>${badge}${releaseButton}</div>`);
                    currentRoles.append(listItem);
                    if (assignment.remaining_time) {
                        startCountdown(assignment.role, assignment.remaining_time);
                    }
                });

                // Populate waiting queue
                data.roles.forEach(function(role) {
                    var listItem = $('<li class="list-group-item"></li>');
                    var totalWaitingTime = role.requests.length * 5 * 1.1; // Calculate total waiting time
                    var queueItems = role.requests.map(function(request, index) {
                        if (index === 0) {
                            return `<li class="list-group-item d-flex justify-content-between align-items-center">[${request.alliance}]${request.player}${request.coordinates ? ' (' + request.coordinates + ')' : ''} <button onclick="assignRole('${role.role}')" class="btn btn-success btn-sm">Assign</button></li>`;
                        }
                        return `<li class="list-group-item">[${request.alliance}]${request.player}${request.coordinates ? ' (' + request.coordinates + ')' : ''}</li>`;
                    }).join('');
                    listItem.html(`<strong>${role.role.replace('_', ' ')}: Total Waiting Time: ${totalWaitingTime.toFixed(1)} minutes</strong><ul class="list-group mt-2">${queueItems}</ul>`);
                    waitingQueue.append(listItem);
                });
            },
            error: function() {
                alert('Failed to fetch role data.');
            }
        });
    }

    function startCountdown(role, remainingTime) {
        var display = document.getElementById('time_' + role);
        var timer = Math.floor(remainingTime * 60);  // Convert minutes to seconds

        if (remainingTime === 5) {  // Initialize to full duration if remaining_time is 5 minutes
            timer = 5 * 60;
        }

        timers[role] = setInterval(function() {
            var minutes = parseInt(timer / 60, 10);
            var seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(timers[role]);
                releaseRole(role);
            }
        }, 1000);
    }

    function releaseRole(role) {
        $.get('/release_role/' + role, function(data) {
            if (data.status === 'success') {
                fetchRoles();
            } else {
                alert('Failed to release role.');
            }
        });
    }

    function assignRole(role) {
        $.get('/assign_role/' + role, function(data) {
            if (data.status === 'success') {
                fetchRoles();
            } else {
                alert('No player available for this role.');
            }
        });
    }

    $(document).ready(function() {
        fetchRoles();

        $('#request-role-form').submit(function(event) {
            event.preventDefault();
            $.post('/request_role', $(this).serialize(), function(data) {
                if (data.status === 'success') {
                    fetchRoles();
                } else {
                    alert('Failed to request role.');
                }
            });
        });
    });
</script>
{% endblock %}
